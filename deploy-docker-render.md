# Деплой create-react-app приложения в Docker с облачной базой данных

Структура проекта выглядит следующим образом:

```
your-app/
  ├── client/
  │    ├── package.json
  │    ├── ...
  ├── server/
  │    ├── package.json
  │    ├── ...
  ├── Dockerfile
  ├── .dockerignore
```

1. Добавь к серверу middleware `express.static` так, чтобы она 'смотрела' на папку `/client/build`:

```jsx
app.use(express.static(path.join(__dirname, '../../client/build')));
```

2. Пропиши роут '\*', который будет на все необработанные url отдавать `index.html` (вставляется после всех остальных роутов). Это нужно, чтобы сервер мог отдавать ваше приложение не только по корневому url `"/"`, но и по внутренним url типа `"/todos/1"`, `"/auth/register"` и т.д.

```jsx
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, '../client/build/index.html'));
});
```

3. `database.json` должен выглядеть таким образом:

```json
{
  "development": {
    "use_env_variable": "DATABASE_URL"
  },
  "production": {
    "use_env_variable": "DATABASE_URL",
    "dialectOptions": {
      "ssl": {
        "rejectUnauthorized": false
      }
    }
  }
}
```
DATABASE_URL — это ссылка для подключения к вашей облачной базе данных. Если вы делали её на Supabase. Переходим в `Project Settings` -> `Database` -> `Connection string` и копируем строку подключения, которая будет использоваться как переменная окружения  далее в Dockerfile(**важно!** не забыть вписать пароль который использовался при создании проекта)

4. Создай Dockerfile в корне проекта

```docker
# Используем официальный образ Node.js 18
FROM node:18

# Устанавливаем рабочую директорию
WORKDIR /app

# Устанавливаем переменные окружения
ENV DATABASE_URL=<здесь будет url вашей облачной базы данных!>

# Копируем обе части приложения (клиентскую и серверную) в контейнер
COPY . .

# Установка зависимостей и сборка клиентской части
RUN cd client && npm install && npm run build

# Установка зависимостей для серверной части
RUN cd server && npm install

# Определяем порт, который будет прослушивать сервер
EXPOSE 4000

# Запускаем сервер при запуске контейнера
CMD [ "node", "server/app.js" ]
```

5. Создай .dockerignore. Туда пропишите нужные файлы и папки:

```docker

# Docker будет игнорировать эти папки при копировании файлов проекта в контейнер
node_modules/

```

6. Проверь работоспособность production билда/сборки:

- 1 шаг. Создайте образ на основе Dockerfile

```bash
docker build -t <имя вашего образа> .
```

- 2 шаг. Запусти контейнер на основе созданного образа (с последующем удалением после остановки)

```bash
docker run --name <имя контейнера> --rm -p 4000:4000 <имя вашего образа>
```

- 3 шаг. Если контейнер запустился, зайди на `localhost:4000`, проверь, что приложение отрабатывает как надо
*Если что-то не получилось — читайте ошибки в терминале и исправляйте их*

- 4 шаг. Чтобы остановить контейнер, открой новый терминал и пропиши:

```bash
docker ps
```

Ты увидишь список запущенных контейнеров. Скопируй `CONTAINER ID` твоего контейнера, и затем останови его следующей командой:

```bash
docker stop <container_id>
```

7. Удали лишние папки `.git` из папок `server`и `client`
8. Запушь код в репозиторий GitHub.

9. Войди на [render.com](http://render.com/). Создаём новый веб-сервер (New -> Web Service). В поле Region выбираем "Frankfurt (EU)". 
10. Соединяем его с нашим репозиторием. Выбираем ветку из которой будет собираться билд (Branch)
11. Runtime: `Docker`
12. Готово! Если что-то идёт не так — смотрите логи деплоя. Теперь каждый раз после пуша в выбранную ветку деплой будет происходить автоматически.

